# {{ ansible_managed }}
# Generated by Ansible â€” do not edit manually
services:
{% for name, svc in infra_services.items() %}
{% if svc.enabled | default(true) | bool %}

  {{ name }}:
    image: {{ svc.image }}
    container_name: {{ name }}
{% if svc.command is defined %}
    command: >-
      {{ svc.command }}
{% endif %}
{% if svc.env is defined %}
    environment:
{% for key, val in svc.env.items() %}
      {{ key }}: "{{ val }}"
{% endfor %}
{% endif %}
{% if svc.ports is defined %}
    ports:
      - "{{ svc.port }}:{{ svc.port }}"
{% if svc.console_port is defined %}
      - "{{ svc.console_port }}:{{ svc.console_port }}"
{% endif %}
{% endif %}
{% if svc.volumes is defined %}
    volumes:
{% for vol in svc.volumes %}
      - {{ vol }}
{% endfor %}
{% endif %}
{% if name == 'mysql' and has_mysql | bool %}
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
{% endif %}
    networks:
      - {{ network_name }}
{% if svc.resources is defined and svc.resources.memory is defined %}
    deploy:
      resources:
        limits:
          memory: {{ svc.resources.memory }}
{% endif %}
{% if svc.health_check_cmd is defined %}
    healthcheck:
      test: ["CMD-SHELL", "{{ svc.health_check_cmd }}"]
      interval: 30s
      timeout: 10s
      retries: 5
{% endif %}
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "{{ docker_log_max_size }}"
        max-file: "{{ docker_log_max_files | string }}"
{% endif %}
{% endfor %}

{% for name, svc in app_services.items() %}

  {{ name }}:
    image: {{ svc.image }}:${{{ name | upper | replace('-', '_') }}_TAG:-{{ svc.tag }}}
    container_name: {{ name }}
{% if svc.env is defined %}
    environment:
{% for key, val in svc.env.items() %}
      {{ key }}: "{{ val }}"
{% endfor %}
{% if svc.java_opts is defined %}
      JAVA_OPTS: "{{ svc.java_opts }}"
{% endif %}
{% endif %}
    ports:
      - "{{ svc.port }}:{{ svc.port }}"
{% if name == 'gui-app' %}
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
{% endif %}
    networks:
      - {{ network_name }}
{% if svc.depends_on is defined %}
    depends_on:
{% for dep in svc.depends_on %}
{% if dep in infra_services and infra_services[dep].health_check_cmd is defined %}
      {{ dep }}:
        condition: service_healthy
{% else %}
      {{ dep }}:
        condition: service_started
{% endif %}
{% endfor %}
{% endif %}
{% if svc.resources is defined and svc.resources.memory is defined %}
    deploy:
      resources:
        limits:
          memory: {{ svc.resources.memory }}
{% endif %}
{% if svc.health_check is defined %}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:{{ svc.port }}{{ svc.health_check }}"]
      interval: {{ svc.health_check_interval | default(30) }}s
      timeout: 10s
      retries: 5
      start_period: 60s
{% endif %}
    restart: on-failure
    logging:
      driver: json-file
      options:
        max-size: "{{ docker_log_max_size }}"
        max-file: "{{ docker_log_max_files | string }}"
{% endfor %}

networks:
  {{ network_name }}:
    driver: bridge

volumes:
{% for name, svc in infra_services.items() %}
{% if svc.enabled | default(true) | bool and svc.volumes is defined %}
{% for vol in svc.volumes %}
{% set vol_name = vol.split(':')[0] %}
{% if not vol_name.startswith('.') and not vol_name.startswith('/') %}
  {{ vol_name }}:
{% endif %}
{% endfor %}
{% endif %}
{% endfor %}
