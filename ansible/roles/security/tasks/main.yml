---
- name: Security - Install UFW and fail2ban
  ansible.builtin.apt:
    name:
      - ufw
      - fail2ban
    state: present

- name: Security - Reset UFW
  community.general.ufw:
    state: reset

- name: Security - Set UFW default deny incoming
  community.general.ufw:
    direction: incoming
    policy: deny

- name: Security - Set UFW default allow outgoing
  community.general.ufw:
    direction: outgoing
    policy: allow

- name: Security - Allow standard ports
  community.general.ufw:
    rule: allow
    port: "{{ item.port | string }}"
    proto: "{{ item.proto }}"
  loop: "{{ security_ufw_allowed_ports }}"

- name: Security - Allow extra ports
  community.general.ufw:
    rule: allow
    port: "{{ item.port | string }}"
    proto: "{{ item.proto }}"
  loop: "{{ security_ufw_extra_rules }}"

- name: Security - Enable UFW
  community.general.ufw:
    state: enabled

- name: Security - Harden SSH config
  ansible.builtin.template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: "0644"
    validate: "sshd -t -f %s"
  notify: Security - Restart sshd

- name: Security - Configure fail2ban
  ansible.builtin.copy:
    dest: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = {{ security_fail2ban_bantime }}
      maxretry = {{ security_fail2ban_maxretry }}

      [sshd]
      enabled = true
      port = {{ security_ssh_port }}
      logpath = /var/log/auth.log
    owner: root
    group: root
    mode: "0644"
  when: security_fail2ban_enabled
  notify: Security - Restart fail2ban

- name: Security - Enable fail2ban
  ansible.builtin.service:
    name: fail2ban
    state: started
    enabled: true
  when: security_fail2ban_enabled
