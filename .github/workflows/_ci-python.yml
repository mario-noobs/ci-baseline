name: CI â€” Python

on:
  workflow_call:
    inputs:
      python_version:
        type: string
        default: "3.8"
      requirements_file:
        type: string
        default: "requirements.txt"
      test_enabled:
        type: boolean
        default: false
      sonar_project_key:
        type: string
        required: true
      sonar_organization:
        type: string
        default: "mario-noobs"
    secrets:
      SONAR_TOKEN:
        required: true

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ inputs.python_version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ inputs.python_version }}-${{ hashFiles(inputs.requirements_file) }}
          restore-keys: pip-${{ runner.os }}-${{ inputs.python_version }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ${{ inputs.requirements_file }}

      - name: Run tests
        if: inputs.test_enabled
        run: |
          pip install pytest pytest-cov
          pytest --cov --cov-report=xml -v

      - name: Upload coverage report
        if: inputs.test_enabled
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 7

  sonarcloud:
    name: SonarCloud
    needs: build-and-test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download coverage report
        if: inputs.test_enabled
        uses: actions/download-artifact@v4
        with:
          name: coverage-report

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: SonarCloud scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=${{ inputs.sonar_project_key }}
            -Dsonar.organization=${{ inputs.sonar_organization }}
            -Dsonar.python.coverage.reportPaths=coverage.xml
